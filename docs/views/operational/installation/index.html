<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/livinglab-docs/scripts/script.js"></script>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/livinglab-docs/css/base.css">
    <link rel="stylesheet" href="/livinglab-docs/css/view.css">
    <link rel="stylesheet" href="/livinglab-docs/css/references.css">
    <link rel="stylesheet" href="/livinglab-docs/css/dark.css" media="(prefers-color-scheme: dark)" id="dark-css">
    <title>Installation</title>
</head>
<body>
    <header>
        <a href="/livinglab-docs/">QGG LivingLab</a>
        <span>
            Theme:
            <select class="theme-selector">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
            </select>
        </span>
    </header>
    <div class="content-wrapper">
    <nav class="sidebar">
        
        <ol class="sidebar-list-outer">
            <li><span class="sidebar-category">Frontmatter</span>
                <ol>
                    <li class="sidebar-link">
                        <a href="/livinglab-docs/introduction/">Introduction</a>
                    </li>
                    <li class="sidebar-link">
                        <a href="/livinglab-docs/stakeholders/">Stakeholders</a>
                    </li>
                    <li class="sidebar-link">
                        <a href="/livinglab-docs/quality-properties/">Quality properties</a>
                    </li>
                    <li class="sidebar-link">
                        <a href="/livinglab-docs/architecture-overview/">Architecture overview</a>
                    </li>
                </ol>
            </li>
            <li><span class="sidebar-category">Architectural views</span>
                <ol>
                    <li class="sidebar-link">
                        <a href="/livinglab-docs/views/context/context-model/">Context model</a>
                    </li>
                    <li class="sidebar-link">
                        <a href="/livinglab-docs/views/functional/functional-structure/">Functional structure</a>
                    </li>
                    <li>
                        <button class="sidebar-expander">
                            <span>Information views</span>
                            <svg class="chevron" focusable="false" viewBox="0 0 16 16" width="16" height="16" overflow="visible"><path d="M5.22 3.22a.749.749 0 0 1 1.06 0l4.25 4.25a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 1 1-1.06-1.06L8.939 8 5.22 4.28a.749.749 0 0 1 0-1.06Z"></path></svg>
                        </button>
                        <ol class="sidebar-expandable">
                            <li class="sidebar-link">
                                <a href="/livinglab-docs/views/information/static-information-structure/">Static information structure</a>
                            </li>
                            <li class="sidebar-link">
                                <a href="/livinglab-docs/views/information/information-flow/">Information flow</a>
                            </li>
                        </ol>
                    </li>
                    <li class="sidebar-link">
                        <a href="/livinglab-docs/views/concurrency/concurrency-model/">Concurrency model</a>
                    </li>
                    <li>
                        <button class="sidebar-expander">
                            <span>Development views</span>
                            <svg class="chevron" focusable="false" viewBox="0 0 16 16" width="16" height="16" overflow="visible"><path d="M5.22 3.22a.749.749 0 0 1 1.06 0l4.25 4.25a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 1 1-1.06-1.06L8.939 8 5.22 4.28a.749.749 0 0 1 0-1.06Z"></path></svg>
                        </button>
                        <ol class="sidebar-expandable">
                            <li class="sidebar-link">
                                <a href="/livinglab-docs/views/development/module-structure/">Module structure</a>
                            </li>
                            <li class="sidebar-link">
                                <a href="/livinglab-docs/views/development/codeline-organisation/">Codeline organisation</a>
                            </li>
                        </ol>
                    </li>
                    <li>
                        <button class="sidebar-expander">
                            <span>Deployment views</span>
                            <svg class="chevron" focusable="false" viewBox="0 0 16 16" width="16" height="16" overflow="visible"><path d="M5.22 3.22a.749.749 0 0 1 1.06 0l4.25 4.25a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 1 1-1.06-1.06L8.939 8 5.22 4.28a.749.749 0 0 1 0-1.06Z"></path></svg>
                        </button>
                        <ol class="sidebar-expandable">
                            <li class="sidebar-link">
                                <a href="/livinglab-docs/views/deployment/runtime-platform/">Runtime platform</a>
                            </li>
                            <li class="sidebar-link">
                                <a href="/livinglab-docs/views/deployment/network-model/">Network model</a>
                            </li>
                        </ol>
                    </li>
                    <li>
                        <button class="sidebar-expander">
                            <span>Operational views</span>
                            <svg class="chevron" focusable="false" viewBox="0 0 16 16" width="16" height="16" overflow="visible"><path d="M5.22 3.22a.749.749 0 0 1 1.06 0l4.25 4.25a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 1 1-1.06-1.06L8.939 8 5.22 4.28a.749.749 0 0 1 0-1.06Z"></path></svg>
                        </button>
                        <ol class="sidebar-expandable">
                            <li class="sidebar-link">
                                <a href="/livinglab-docs/views/operational/installation/">Installation</a>
                            </li>
                            <li class="sidebar-link">
                                <a href="/livinglab-docs/views/operational/migration/">Migration</a>
                            </li>
                            <li class="sidebar-link">
                                <a href="/livinglab-docs/views/operational/administration/">Administration</a>
                            </li>
                        </ol>
                    </li>
                </ol>
            </li>
            <li><span class="sidebar-category">Backmatter</span>
                <ol>
                    <li class="sidebar-link">
                        <a href="/livinglab-docs/glossary/">Glossary</a>
                    </li>
                    <li class="sidebar-link">
                        <a href="/livinglab-docs/references/">References</a>
                    </li>
                </ol>
            </li>
        </ol>
      </nav>
    <main>
        <h1>Installation</h1>
<p class="view-description">This view describes the software elements that need to be installed to move the system into production.
</p>







<p>TODO figure out best way to handle versioning of dependencies.</p>
<p>This view assumes that the database server and application server are distinct hosts.</p>



<h2>Packages/modules</h2>

<p>In the following table, <code>X</code> refers to the most recent stable release of PostgreSQL available for the operating system, and <code>Y</code> refers to the latest version of .NET.</p>
<table>
<thead>
<tr>
<th>Element</th>
<th>Debian</th>
<th>Rocky Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td>PostgreSQL server</td>
<td><code>postgresql-X</code></td>
<td><code>postgresql:X/server</code></td>
</tr>
<tr>
<td>PostgreSQL client</td>
<td><code>postgresql-client-X</code></td>
<td><code>postgresql:X/client</code></td>
</tr>
<tr>
<td>ASP.NET Core Runtime</td>
<td><code>aspnetcore-runtime-Y</code></td>
<td><code>aspnetcore-runtime-Y</code></td>
</tr>
<tr>
<td>Nginx</td>
<td><code>nginx</code></td>
<td><code>nginx</code></td>
</tr>
</tbody>
</table>
<p>Note the following:</p>
<ul>
<li>The PostgreSQL server packages depend on the client packages.</li>
<li>On Rocky Linux, remember to enable the <code>postgresql</code> module before installing PostgreSQL packages.</li>
<li>The ASP.NET Core Runtime depends on the .NET Runtime (TODO at least on Rocky, but on Debian?).</li>
<li>The ASP.NET Core Runtime is not included in Debian's default package directory, so to install the package <code>aspnetcore-runtime-Y</code>, it is necessary to first install the package <code>packages-microsoft-prod.deb</code> from the <a href="https://packages.microsoft.com/config/debian/">Linux software repository for Microsoft products</a>. See also <a href="https://learn.microsoft.com/en-us/dotnet/core/install/linux-debian">Microsoft's instructions</a> (TODO wget vs. curl?) for installing the package.</li>
</ul>



<h2>Deployment on hosts</h2>

<h3>Database server</h3>
<ul>
<li>Operating system</li>
<li>PostgreSQL server</li>
<li>PostgreSQL client</li>
<li>Database schemas: TODO installation (and configuration management)</li>
</ul>
<h3>Application server</h3>
<ul>
<li>Operating system</li>
<li>PostgreSQL client</li>
<li>ASP.NET Core Runtime</li>
<li>Nginx</li>
<li>Back-end application: TODO dll files</li>
<li>Front-end: TODO static files</li>
</ul>
<h3>Client host</h3>
<ul>
<li>Web browser</li>
</ul>



<h2>PostgreSQL configuration (Rocky Linux)</h2>

<p>TODO this is temporarily here.</p>
<p>To configure the installation of the PostgreSQL server, perform the following actions on the database server:</p>
<ol>
<li>
<p>Initialise the database cluster (create data directory, config files, etc. in <code>/var/lib/pgsql</code>):</p>
<pre><code>postgresql-setup --initdb
</code></pre>
</li>
<li>
<p>Allow external connections: In <code>/var/lib/pgsql/data/postgresql.conf</code>, change the line (TODO check the more secure way to do this)</p>
<pre><code>listen_addresses = '*'
</code></pre>
</li>
<li>
<p>Allow connections from the application server: In <code>/var/lib/pgsql/data/pg_hba.conf</code>, append the line</p>
<pre><code>host    all     all     172.16.2.82/32     trust
</code></pre>
<p>Note that the last column <code>trust</code> should be changed to configure password authentication. TODO</p>
</li>
<li>
<p>Enable and start the PostgreSQL service:</p>
<pre><code>systemctl enable postgresql
systemctl start postgresql
</code></pre>
</li>
<li>
<p>Configure firewalld to allow traffic from the application server on port 5432 (TODO check if this is the best way):</p>
<pre><code>sudo firewall-cmd --add-rich-rule='rule family=&quot;ipv4&quot; source address=&quot;172.16.2.82&quot; port port=5432 protocol=tcp accept' --permanent
sudo firewall-cmd --reload
</code></pre>
</li>
</ol>
<p>Afterwards, test the connection on the application server:</p>
<pre><code>psql -h 172.16.2.81 -U postgres -d postgres
</code></pre>
<p>TODO: Consider how much of this can be brought under configuration management.</p>



<h2>Nginx configuration</h2>

<p>TODO this is also temporarily here.</p>
<p>Perform the following actions on the application server:</p>
<ol>
<li>
<p>Allow HTTP traffic through the firewall:</p>
<pre><code>firewall-cmd --permanent --add-service=http
firewall-cmd --reload
</code></pre>
</li>
<li>
<p>Modify <code>/etc/nginx/nginx.conf</code> to the following:</p>
<pre><code>daemon off;
events {}
http {
    access_log /dev/stdout;
    error_log /dev/stderr;
    server {
        listen 80;
        location / {
            proxy_pass http://localhost:5000;
        }
    }
}
</code></pre>
<p>This configures Nginx to act as a proxy server for incoming HTTP traffic, redirecting it to <code>localhost:5000</code>. Furthermore, Nginx will not act as a daemon, and will output access and error information to standard output and error, respectively.</p>
</li>
<li>
<p>Start Nginx by running <code>nginx</code>.</p>
</li>
</ol>
<p>The configuration can be tested by also running an API on the application server listening on port 5000, and sending requests to the application server from a different host.</p>



<h2>SELinux configuration</h2>

<p>By default, SELinux is likely to block Nginx from connecting to port 5000 on localhost, at least when Nginx runs as a service. To allow this, create a custom policy module as follows:</p>
<ol>
<li>
<p>Run the Nginx service.</p>
</li>
<li>
<p>Find the domain under which Nginx runs:</p>
<pre><code>ps -eZ | grep nginx
</code></pre>
<p>In the present case, the domain is <code>httpd_t</code>.</p>
</li>
<li>
<p>Find the label attached to the desired port, here 5000:</p>
<pre><code>semanage port -l | grep 5000
</code></pre>
<p>In this case the label is <code>commplex_main_port_t</code>.</p>
</li>
<li>
<p>Create a custom policy module <code>nginx_commplex.te</code> (this file can be saved anywhere):</p>
<pre><code>module nginx_commplex 1.0;
require {
    type httpd_t;
    class tcp_socket name_connect;
    type commplex_main_port_t;
}
allow httpd_t commplex_main_port_t:tcp_socket name_connect;
</code></pre>
</li>
<li>
<p>Compile the module:</p>
<pre><code>checkmodule -M -m -o nginx_commplex.mod nginx_commplex.te
semodule_package -o nginx_commplex.pp -m nginx_commplex.mod
</code></pre>
</li>
<li>
<p>Install the module:</p>
<pre><code>semodule -i nginx_commplex.pp
</code></pre>
<p>The <code>.mod</code> and <code>.pp</code> files can then safely be deleted.</p>
</li>
</ol>
<p>To uninstall the module, run the command:</p>
<pre><code>semodule -r nginx_commplex
</code></pre>


    </main>
    </div>
    <footer>
        QGG Aarhus University
    </footer>
    <script>

  // Get the current page's URL path
  const currentPath = window.location.pathname;

  // Find all sidebar links
  const links = document.querySelectorAll('nav a');

  links.forEach(link => {
    const href = link.getAttribute('href');
    if (href === currentPath || href + 'index.html' === currentPath) {
        const linkContainer = link.parentNode;
        linkContainer.classList.add('current');
        
        const linkIsNested = linkContainer.parentNode.classList.contains("sidebar-expandable");
        if (linkIsNested) {
            const expandable = linkContainer.parentNode;
            expandable.style.display = "block";

            const chevron = expandable.parentNode.querySelector(".chevron");
            chevron.classList.add('open');

            const expander = expandable.parentNode.querySelector(".sidebar-expander");
            expander.classList.add("current");
            expander.classList.add("open");
        }
    }
  });

  
  // Add toggle to buttons in sidebar
  document.querySelectorAll(".sidebar-expander").forEach(btn => {
        btn.addEventListener("click", function() {
            const expandable = this.parentNode.querySelector(".sidebar-expandable");
            const isHidden = window.getComputedStyle(expandable).display === "none";
            expandable.style.display = isHidden ? "block" : "none";
            
            const chevron = this.querySelector(".chevron");
            chevron.classList.toggle("open");
            this.classList.toggle("open");
        });
    });


    document.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => {
  document.body.classList.add("loaded");
  }, 10);
});
</script>
</body>
</html>